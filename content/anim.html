<header class="mini">
<h2>Unity Animation</h2>
<p>Creating a playable character</p>
</header>

<h3>Introduction</h3>

<p>Creating a playable character in Unity takes more work than just having a model and animation clips. In the next sections we are going to look at the basics of how to put together the model and its animation clips in a playable character starting from a <i>*.fbx</i> file containing the data.</p>


<h3>Importing, Rigging & Avatar</h3>

<p>Importing an <i>fbx</i>  file into Unity is as simple as placing it in the <code>"YourProjectName"/Assets/</code> folder. Inside Unity it will look like a single object with an side arrow. Expanding it will show everything contained inside, like the armature, skinning, materials, mesh, animation clips or anything else.</p>

<img class="image fit" src="images/fbx.png"></img>

<p>In our case we have a dog "kolly". As soon as you select the fbx the inspector window  will have the import settings.</p>

<div class="spotlight">
	<div class="image flush"> <img class="image 50%" src="images/rigging.png"></img></div>
	<div class="inner2">
		<p>On the <i>rig</i> tab you can specify the following properties:
		<ul>
			<li><b>Animation type:</b> <code>humanoid</code> for humanoids and <code>generic</code> for any other type of characters.</li>
			<li><b>Avatar definition:</b> <code>no avatar</code>, <code>create from this model</code> and <code>copy from other avatar</code>. An avatar is an object that relates the bones animation to the mesh deformation or <i>muscles definition</i>. It is very useful for humanoid characters because it let one connect different shaped bodies to the same animation. For example, you could use the same walking animation for characters with different height. Another point is: you can't use an AnimatorController without having an avatar, even if you don't plan to use various characters with different shapes.</li>
			<li><b>Root node:</b> the root bone of the skeleton (only appears for generic types).</li>
			<li><b>Skin weights:</b> Bone/mesh interaction weights import mode.</li>
		</ul>
		</p>
	</div>
</div>
<br>
<p>After configuring the rigging you must "apply" the modifications and Unity will process them.</p>


<h3>Animation clips: cut, loop and cycle</h3>

<p>The next tab after rig is the <i>Animation</i>. In this tab you can select to import or not animation clips, re-sample/compress its curves and edit animation clips properties.</p>

<img class="image fit" src="images/anim.png"></img>

<p>Following the general properties, there is a list of animation clips. When selecting any of the clips and scrolling down there will be options of how to export this clip.
<ul>
	<li><b>Length bar:</b> here one can cut the clip. It is useful for various situations, for example when all clips are in the same take, you can cut and separate them and also when fine tunning the length for with a controller and blend trees.</li>
	<li><b>Loop Time:</b> Enables the animation to loop.</li>
	<li><b>Loop Pose:</b> For animations where the final pose is different from the initial pose, enabling this option smooths the animation loop between pose.</li>
	<li><b>Cycle Time:</b> Normalized starting time of the animation \( \in [0,1]\). Useful to synchronize clips in a blend tree like walking/running.</li>
</ul>
</p>
<div style="margin: 3rem">
	<div class="image 50%" style="text-align: center">
	Without loop pose.<br>
	<video src="images/not_smooth.webm" controls></video>
	</div>
	<div class="image 50%" style="text-align: center">
	With loop pose.<br>
	<video src="images/smooth.webm" controls>
	</video>
	</div>
</div>
<br>
<h4>Root Motion Options</h4>

<p>Animation clips where the root transform bone changes along the clip are considered to have root motion. Unity takes the delta between animation frames and apply this movement (rotations and translations) to the entire game object. For example an walking animation where the root bone starts at position \(p_0\) and ends at \(p_1 \neq p_0\) would have a motion in the direction \(p_1 - p_0\) making the gameObject whose it is attached to move in the scene.</p>

<p>The options <code>Root Transform</code> control how the root motion should be interpreted by Unity. Enabling <code>Bake Into Pose</code> does not apply it to the gameObject. One can choose separately which movements (transforms) to apply or bake, they are <code>Rotation</code>, <code>Transform Y</code>(vertical move), <code>Transform XZ</code>(horizontal move).</p>

Other options are:
<div class="spotlight">
	<div class="image flush"> <img class="image 50%" src="images/rootmotion.png"></img></div>
	<div class="inner2">
		<ul>
			<li><b>Curves:</b> Create additional parameter curve based on animation time, which can be used to control other effects/events.</li>
			<li><b>Events:</b> Enable to control external events based on animation time.</li>
			<li><b>Mask:</b> Control which bones to animate.</li>
			<li><b>Motion:</b> Choose from which bone comes the root motion if other than the root.</li>
		</ul>
	</div>
</div>

<!-- TODO fix video size -->
<div style="margin: 3rem;">
	<div class="image 50%" style="text-align: center; float: left;">
	With root motion.<br>
		<div class="video-container">
		<video width="428" height="334" src="images/rootmotion.webm" frameborder="0" controls></video>
		</div>
	</div>
	<div class="image 50%" style="text-align: center;">
		Baked root motion.<br>
		<div class="video-container">
		<video width="428" height="334" src="images/bakedrootmotion.webm" frameborder="0" controls></video>
		</div>
	</div>
</div>
<br>

<h3>Keyframe Edit & Preview</h3>

<p>It is possible to edit and preview each key-frame of an animation clip. While it isn't a graphical interactive tool, one can make simple modifications to the numeric values of the transformation (position, rotation and scale) of each bone and the root motion, adding/removing key-frames of the full clip or particular bones.</p>

<img class="image fit" src="images/animwindow.png"></img>

<p>One can open the animation window by double click in any animation or in the menu <code>Window > Animation > Animation (CTRL+6)</code>. To enable the preview of the selected key-frame it is necessary to, after having the window open, select the proper gameObject in the scene.</p>

<h3>Animator & Character Controller</h3>
<div class="spotlight">
	<div class="image flush">
		<img class="image" src="images/animator.png"></img>
	</div>
	<div class="inner2">
		<p>In order to create an animated character it is necessary to have an <i>Animator</i> Component in the desired gameObject. This component requires a <code>Controller</code> which is a state machine for the animation clips, and an <code>Avatar</code>, in our case the one created when selecting the <i>Rig</i> properties while importing the fbx file. The other parameters are <code>Update Mode</code> which controls how the animation updates are made (synchronous or asynchronous with the physics engine), and <code>Culling Mode</code> which controls if and how the animation is played when the gameObject is not (or partially) visible.
		</p>
	</div>
</div>

<h4>Animator Controller</h4>

<p>The animator controller is a <i>state machine</i> where the behavior of the character animation is defined. It is composed of parameters, states, and transitions.</p>

<img class="image fit" src="images/animatorcontroller.png"></img>

<p>The parameters are created by the user on the "plus" sign, they can be of four types: boolean, float, integer or trigger (which is a boolean that resets its state when consumed by some transition). Those parameters can be used used to control both the transition conditions and the animation blending. They are accessed by their name and type from C#.</p>
<div id="animatorSet"><script> loadGist("animatorSet",'https://gist.github.com/caioc2/6538f07e4d083c7ec046803cdfcb46a4.json');</script></div>
<p> where:
<ul>
    <li><code>void SetFloat(string name, float value, float dampTime, float deltaTime);</code></li>
	<li><code>void SetInteger(string name, int value);</code></li>
	<li><code>void SetBool(string name, float value);</code></li>
</ul>
The parameters can also be read with the equivalent "Get" functions.
</p>

<div class="spotlight">
	<div class="image flush">
		<img class="image" src="images/transition.png"></img>
	</div>
	<div class="inner2">
		<p>Transitions are descriptions of how and when to move between states. They can be created by right click on a source state and selecting <code>Make transition</code> and then clicking on the destination state.
		The condition list is treated as a logic "and" among the selected variables and its values. For booleans it admits <code>true/false</code>, for floating point <code>less/greater than</code> and for integer <code>less/greater than, equal, not equal</code>. One can create the logic "or" by creating multiple transitions between the same two states. More complex conditions can also be handled by C# code and setting a single boolean as transition.</p>
		<div id="complexc"><script>loadGist('complexc','https://gist.github.com/caioc2/7d4d917f82b5b67385c78b5fcd5322be.json');</script></div>
		<p>In this example we check for not walking (steering/forward velocity) and other states like crouch, jump, if it is grounded and how much time it is in this condition to set the idle boolean.</p>
	</div>
</div>

<p>The other transition settings are:</p>
<ul>
    <li><b>Has Exit Time:</b> When enabled forces the transition to happens only at a certain point in the animation. Even if all transition conditions are met, it will delay the transition until that point. It should be used wisely as this delay may appears to the user as lack of responsiveness for the controller.</li>
	<li><b>Exit Time:</b> The point in normalized animation clip length where the transition can occur.</li>
	<li><b>Fixed Time:</b> When enabled the transition time is taken in seconds, otherwise it is taken in normalized animation time.</li>
	<li><b>Transition Duration:</b> Duration of the transition.</li>
	<li><b>Transition offset:</b> Normalized time of where to start the animation which is being transitioned to.</li>
	<li><b>Interruption source:</b> How interruption should be handled, possible values are <code>None</code>, <code>Current State</code>, <code>Next State</code>, <code>Current then Next State</code> and <code>Next then Current State</code></li>
</ul>

<p>Finally, the states can contain a <i>single animation clip</i>, a <i>blend-tree of clips</i> or a <i>sub-state machine</i>.</p>

<p>The default states are:</p>
<ul>
    <li><font color="#35d035"><b>Entry</b></font>: When entering the (sub)state machine, it starts in this state.</li>
	<li><font color="#f09624"><b>Default</b></font>: When initializing, it starts in this state, there is always a unconditional transition from entry to the default state.</li>
	<li><font color="#dc1616"><b>Exit</b></font>: Leaves from the (sub)state machine.</li>
	<li><font color="#6fc5b6"><b>Any State</b></font>: A shortcut for creating transitions for all states. If all states can transit to a <i>X</i> state with the same condition, then one can use any <code>Any State -> X</code> as a shortcut, it also avoids cluttering the screen with transitions for each state. Transitions can only be crated from <i>Any State</i> to another state, not the inverse direction.</li>
	<li><font color="#999999"><b>Common</b></font>: Normal user defined states.</li>
</ul>

<p>Sub-state machines are <i>"state machines inside a state"</i>, they can be recognized by the  hexagonal form, instead of the rectangular. They are useful to organize complex behaviors and also avoiding cluttering the screen. They have their own entry and exit and an additional state <code>Up(Layer)</code> which goes back to the main state machine.</p>

<p>By double clicking in a sub-state it goes into the layer of this sub-state machine. The following figure show an example of our Idle sub-state machine</p>
<img class="image fit" src="images/substatemachine.png"></img>

<h4>Blend Trees</h4>

<img class="image fit" src="images/blendtree.png"></img>

<p>Inside each state, one can have a single animation clip or various clips mixed by some parameters. This animation "mixer" is called <i>Blend Tree</i>. Each entry in a blend tree can be an animation clip or another blend tree. While a single blend tree can have at maximum two parameters, any parameters of its child blend trees will appear on the parent. Their parameters are matched with the state machine parameters by name and it accepts only floating points.</p>
<p>In the left there is the inspector of a blend tree.</p>
<div class="spotlight">
	<div class="image flush">
		<img class="image" src="images/btdetail.png"></img>
	</div>
	<div class="inner2">
		<ul>
			<li><b>Blend Type:</b> <code>1D</code>, a single parameter controls the blending of all clips in the blend tree. <code>2D</code>, two parameters are used to control the blending among clips. For 2D there are some variations as <code>2D Simple Directional</code>, <code>2D Freeform Directional</code> and <code>2D Freeform Cartesian</code>, any of them can have points freely positioned in the cartesian plane, the difference is how the interpolation of the clips are calculated.</li>
			<li><b>Parameters:</b> The drop-down menu to select which parameter each coordinate represents.</li>
			<li><b>Blending Diagram:</b> The graphical representation of the position of each clip and its influence.</li>
			<li><b>Motion List:</b> The list of clips and child blend trees of this blend tree. Depending of which blend type is selected it shows the 1D or 2D coordinates of the clip, its play speed and mirroring option.</li>
			<li><b>Compute Positions:</b> Auto-position the clips based on it's root motion. The computation can be based in the position or (angular) velocity of the root motion.</li>
		</ul>
	</div>
</div>
<br>
<p>The range of the parameters are automatically computed from the position of the clips. When setting values outside this range, they are clipped.</p>

<!-- -->
anim sync blend

<h3>Physics, Colliders and Raycast</h3>